<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ToDo List</title>
    <link type="text/css" rel="stylesheet" href="css/clear.css">
    <link type="text/css" rel="stylesheet" href="css/style.css">
    <style>
        .hidden{
            display: none;
        }
        .login{
            width: 300px;
            height: 200px;
            padding: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateY(-200px) translateX(-150px);
            display: block;
        }
        .login .box{
            height: 100%;
            border: 2px solid seagreen;
            text-align: center;
        }
        .login .box span{
            display: block;
            font-size: 25px;
            padding: 20px 0px;
            text-align: center;
            line-height: 25px;
        }
        .login .box .name{
            box-sizing: border-box;
            height: 50px;
            line-height: 30px;
            width: 80%;
            margin: 50px 0px;
            font-size: 20px;
            outline: none;
            border: none;
            border-bottom: solid 1px black;

        }
    </style>
</head>
<body>
    <div class="login">
        <div class="box">
            <span>登陆TODOLIST</span>
            <input class="name" type="text" placeholder="请输入登录名">
            <button id="test">测试</button>
            <button id="add">添加</button>
            <button id="logIn">登陆</button>
        </div>
        <div class="test">
            <div id="display"></div>
        </div>
    </div>
    <div class="hidden">
        <nav id="guide" class="blue">
            <h3 class="h3">TODO List</h3>
        </nav>
        <div class="function">
            <input id="input" type="text" placeholder="请输入您的任务"><button id="addMission">添加任务</button>
        </div>
        <div class="list">
            <div class="unfinished">
                <nav class="blue meddle">
                    <h3 class="h3">待办任务</h3>
                </nav>
                <ul id="unfinished-list"></ul>
            </div>
            <div class="finished">
                <nav class="blue meddle">
                    <h3 class="h3">已完成的任务</h3>
                </nav>
                <ul id="finished-list"></ul>
            </div>
        </div>
    </div>
    <script src="js/js.js"></script>
    <script>
        var login = document.getElementsByClassName('login')[0];
        var user = document.getElementsByClassName('name')[0];
        var hidden = document.getElementsByClassName('hidden')[0];
        var test = document.getElementById('test');
        var display = document.getElementById('display');
        var add = document.getElementById('add');
        var logIn = document.getElementById('logIn');
        var username;
        var input = document.getElementById("input");
        var addMission = document.getElementById('addMission');
        var unfinishedList = document.getElementById("unfinished-list");
        var finishedList = document.getElementById("finished-list");
        function finished() {
            var unChild = unfinishedList.getElementsByTagName('li');
            var Child = finishedList.getElementsByTagName('li');
            for(var i = 0; i < unChild.length; i++){
                if(unChild[i].checked){
                    var li = document.createElement('li');
                    li.innerHTML = unChild[i].innerHTML;
                    li.checked = true;
                    save(li.innerHTML);
                    finishedList.appendChild(li);
                    unfinishedList.removeChild(unChild[i]);
                }
            }
        }
        //保存本地未完成
        function saveUN(content) {
            var position = searchName(username);
            var tempStr = localStorage.getItem('obj').split('*');
            var tempJson = JSON.parse(tempStr[position]);
            if(tempJson.unfinished != ""){
                tempJson.unfinished = tempJson.unfinished + '^' + content;
            }else{
                tempJson.unfinished = content;
            }
            var temp = JSON.stringify(tempJson);
            tempStr[position] = temp;
            var str = tempStr[0];
            for(var i = 1; i < tempStr.length; i++){
                str = str + "*" + tempStr[i];
            }
            localStorage.setItem('obj',str);
        }
        //保存本地完成
        function save(content) {
            var position = searchName(username);
            var tempStr = localStorage.getItem('obj').split('*');
            var tempJson = JSON.parse(tempStr[position]);
            if(tempJson.finished != ""){
                tempJson.finished = tempJson.finished + '^' + content;
            }else{
                tempJson.finished = content;
            }
            var temp = JSON.stringify(tempJson);
            tempStr[position] = temp;
            var str = tempStr[0];
            for(var i = 1; i < tempStr.length; i++){
                str = str + "*" + tempStr[i];
            }
            localStorage.setItem('obj',str);
        }
        //输入任务，回车
        addMission.addEventListener('click',function () {
            var value = input.value;
            if(value != ""){
                input.value = "";
                var li = document.createElement('li');
                li.innerHTML = "<input type='checkbox' onclick='finished()'>" + value;
                saveUN(li.innerHTML);
                unfinishedList.appendChild(li);
            }
        });
        //寻找用户，返回位于第几个字符串
        function searchName(name) {
            if (localStorage.getItem('obj')) {
                var tempStr = localStorage.getItem('obj').split('*');
                var tempJson = new Array();
                for (var i = 0; i < tempStr.length; i++) {
                    tempJson[i] = JSON.parse(tempStr[i]);
                    if(tempJson[i].username == name)
                        return i;
                }
            }
            return -1;
        }
        //循环添加li,参数：添加个数,添加在哪里,添加的内容（数组）
        function addLi(length,list,content) {
            for (var i = 0; i < length; i++){
                var li = document.createElement('li');
                li.innerHTML = content[i];
                list.appendChild(li);
            }
        }
        //登入时载入
        function loading() {
            var position = searchName(username);
            var tempStr = localStorage.getItem('obj').split('*');
            var tempJson = JSON.parse(tempStr[position]);
            tempStr = tempJson.unfinished.split('^');
            if(tempStr != ""){
                addLi(tempStr.length,unfinishedList,tempStr);
            }
            tempStr = tempJson.finished.split('^');
            if(tempStr != ""){
                addLi(tempStr.length,finishedList,tempStr);
            }
        }
        //欢迎用户
        function welcome(username) {//欢迎
            alert("欢迎" + username);
            login.style.display = 'none';
            loading();
            hidden.style.display = 'block';
        }
        //添加用户
        add.addEventListener('click',function () {
            if(user.value != ""){
                username = user.value;
                //<input type='checkbox' onclick='finished()'>jj^<input type='checkbox' onclick='finished()'>jj
                var tempJson = {"username" : username, "unfinished" : "", "finished" : ""};
                var tempStr = JSON.stringify(tempJson);
                if(localStorage.getItem('obj')){//本地存储内有信息
                    if(searchName(username) < 0){
                        var str = localStorage.getItem('obj') + '*' + tempStr;
                        localStorage.setItem('obj',str);
                    }
                }else{//本地存储内没信息
                    localStorage.setItem('obj',tempStr);
                }
            }
        });
        //登陆
        logIn.addEventListener('click',function () {
            if(user.value != ""){
                username = user.value;
                if(searchName(username) > -1){
                    welcome(username);
                }else {
                    alert("未找到该用户，请先添加");
                }
            }
        });

    </script>
</body>
</html>